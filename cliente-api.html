<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Productos y Entidades - MongoDB Atlas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            color: #fff;
        }

        body {
            width: 100vw;
            min-height: 100vh;
            background: #081b29;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        ::-webkit-input-placeholder {
            color: #eee;
        }

        ::-moz-placeholder {
            color: #eee;
        }

        :-ms-input-placeholder {
            color: #eee;
        }

        ::placeholder {
            color: #eee;
        }

        header {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 20px;
        }

        .nav-buttons {
            display: flex;
            gap: 20px;
        }

        .nav-buttons button {
            width: 150px;
            font-size: 18px;
            padding: 10px 0;
            border-radius: 40px;
            background: linear-gradient(45deg, #0ef, #c800ff);
            border: none;
            cursor: pointer;
            transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease;
        }

        .nav-buttons button:hover {
            transform: scale(1.05);
        }

        .nav-buttons button:active {
            transform: scale(0.95);
        }

        .nav-buttons button.active {
            background: linear-gradient(45deg, #00ff00, #00c4ff);
            box-shadow: 0 0 15px #00ff00, 0 0 30px #00c4ff;
            animation: glow 1.5s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 10px #00ff00, 0 0 20px #00c4ff;
            }
            to {
                box-shadow: 0 0 20px #00ff00, 0 0 40px #00c4ff;
            }
        }

        .user-actions {
            display: flex;
            gap: 15px;
        }

        .user-actions button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 40px;
            border: 2px solid #0ef;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-actions button:hover {
            background: #0ef;
            color: #081b29;
        }

        .user-actions button i {
            font-size: 18px;
        }

        .wrapper {
            position: relative;
            width: 95vw;
            max-width: 1200px;
            border: 3px solid #00ffff;
            box-shadow: 0 0 50px 0 #00a6bc;
            display: flex;
            flex-direction: column;
            height: auto;
            min-height: 60vh;
        }

        #register-section.active .wrapper,
        #login-section.active .wrapper {
            max-width: 350px;
        }

        #register-section.active .form,
        #login-section.active .form {
            padding: 20px;
        }

        #register-section.active .title,
        #login-section.active .title {
            font-size: 24px;
        }

        #register-section.active .inp input,
        #login-section.active .inp input {
            font-size: 16px;
        }

        #register-section.active .header .wel_text,
        #login-section.active .header .wel_text {
            font-size: 36px;
            line-height: 40px;
        }

        #register-section.active .header .para,
        #login-section.active .header .para {
            font-size: 16px;
            line-height: 20px;
        }

        #productos-section.active .form,
        #entidades-section.active .form {
            padding: 50px;
        }

        #productos-section.active .title,
        #entidades-section.active .title {
            font-size: 36px;
        }

        #productos-section.active .inp input,
        #entidades-section.active .inp input,
        #productos-section.active .inp textarea,
        #entidades-section.active .inp textarea {
            font-size: 22px;
        }

        #productos-section.active .header .wel_text,
        #entidades-section.active .header .wel_text {
            font-size: 52px;
            line-height: 56px;
        }

        #productos-section.active .header .para,
        #entidades-section.active .header .para {
            font-size: 22px;
            line-height: 26px;
        }

        .header {
            background: linear-gradient(to right, #0ef, #c800ff);
            clip-path: polygon(0 0, 100% 0, 100% 80%, 0 100%);
            padding: 20px;
            text-align: center;
        }

        .header .wel_text {
            font-size: 48px;
            line-height: 50px;
        }

        .header .para {
            margin-top: 10px;
            font-size: 20px;
            line-height: 24px;
            letter-spacing: 1px;
        }

        .form {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            height: auto;
            min-height: 300px;
        }

        #productos-section .form, #entidades-section .form {
            justify-content: start;
        }

        .title {
            font-size: 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        .inp {
            position: relative;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
            width: 100%;
        }

        .inp input, .inp textarea {
            border: none;
            outline: none;
            background: none;
            width: 100%;
            padding-right: 40px;
            font-size: 18px;
            color: #0ef;
        }

        .inp textarea {
            min-height: 120px;
            resize: vertical;
        }

        .inp i {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #0ef;
            font-size: 18px;
        }

        button {
            border: none;
            outline: none;
            width: 100%;
            margin-top: 20px;
            padding: 12px 0;
            font-size: 20px;
            border-radius: 40px;
            letter-spacing: 1px;
            cursor: pointer;
            background: linear-gradient(45deg, #0ef, #c800ff);
            transition: transform 0.3s ease;
        }

        button:hover {
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        button.back {
            background: transparent;
            border: 2px solid #0ef;
            margin-top: 25px;
            width: 300px;
            font-size: 22px;
        }

        button.back:hover {
            background: #0ef;
            color: #081b29;
        }

        .footer {
            margin-top: 30px;
            letter-spacing: 0.5px;
            font-size: 16px;
            text-align: center;
        }

        .link {
            color: #0ef;
            text-decoration: none;
        }

        .link:hover {
            text-decoration: underline;
        }

        .content-section {
            display: none;
            flex: 1;
            flex-direction: column;
            height: auto;
        }

        .content-section.active {
            display: flex;
        }

        .alert {
            padding: 12px 15px;
            margin-top: 15px;
            font-size: 16px;
            text-align: center;
            width: 100%;
        }

        .alert-success {
            color: #27ae60;
        }

        .alert-error {
            color: #e74c3c;
        }

        #productos-list, #entidades-list {
            margin-top: 15px;
            width: 100%;
        }

        .producto-card, .entidad-chip {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .entidad-chip {
            background: none;
            padding: 0;
        }

        .entidad-chip > div {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            border-top: none;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .entidad-chip > button.back {
            grid-column: 1 / -1;
            width: 100%;
            max-width: 300px;
            margin: 20px auto 0;
        }

        .producto-card p, .entidad-chip p {
            margin: 8px 0;
            font-size: 18px;
        }

        .producto-card strong, .entidad-chip strong {
            color: #0ef;
        }

        .producto-card small, .entidad-chip small {
            color: #eee;
            font-size: 16px;
        }

        .producto-card button, .entidad-chip button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            width: 100%;
        }

        .entidad-chip > span {
            font-size: 22px;
            font-weight: 500;
            color: #0ef;
            display: block;
            margin-bottom: 15px;
        }

        .product-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            padding: 50px;
            width: 100%;
            height: auto;
            align-items: start;
        }

        .column {
            display: flex;
            flex-direction: column;
            align-items: start;
            width: 100%;
        }

        .create-product, .list-products, .create-entity, .list-entities, .scrape-section {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #00ffff;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .list-products #productos-list, .list-entities #entidades-list {
            margin-top: 10px;
            width: 100%;
        }

        .create-product .inp,
        .list-products .inp,
        .create-entity .inp,
        .list-entities .inp,
        .scrape-section .inp,
        .create-product button,
        .list-products button,
        .create-entity button,
        .list-entities button,
        .scrape-section button {
            width: 100%;
            max-width: none;
        }

        .list-products .alert, .list-entities .alert, .scrape-section .alert {
            width: 100%;
            max-width: none;
        }

        .tabs-container {
            display: flex;
            width: 100%;
            margin-top: 20px;
            gap: 20px;
        }

        .tabs {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 200px;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #0ef;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            text-align: left;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tab.active {
            background: linear-gradient(45deg, #0ef, #c800ff);
            border-color: #00ff00;
            box-shadow: 0 0 10px #0ef;
        }

        .tabs-content {
            flex: 1;
            width: 100%;
        }

        .tab-content {
            display: none;
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .tab-content.active {
            display: grid;
        }

        @media (max-width: 768px) {
            .tabs-container {
                flex-direction: column;
            }

            .tabs {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
                white-space: nowrap;
            }

            .tab {
                flex: 0 0 auto;
            }

            .tabs-content {
                width: 100%;
            }

            .tab-content {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .product-columns {
                grid-template-columns: 1fr;
            }
        }

        #main-nav {
            display: none;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header id="main-nav">
        <div class="nav-buttons">
            <button id="productos-btn" onclick="showSection('productos')">Productos</button>
            <button id="entidades-btn" onclick="showSection('entidades')">Entidades</button>
        </div>
        <div class="user-actions">
            <button id="profile-btn"><i class="fa-solid fa-user"></i> Admin</button>
            <button onclick="logout()"><i class="fa-solid fa-sign-out-alt"></i> Cerrar Sesi√≥n</button>
        </div>
    </header>

    <div class="wrapper">
        <div id="register-section" class="content-section">
            <div class="header">
                <h1 class="wel_text">BIENVENIDO</h1>
                <p class="para">Gesti√≥n de Productos<br />y Entidades<br />MongoDB Atlas</p>
            </div>
            <form class="form">
                <h1 class="title">Registro</h1>
                <div class="inp">
                    <input type="email" id="register-email" class="input" placeholder="Email">
                    <i class="fa-solid fa-envelope"></i>
                </div>
                <div class="inp">
                    <input type="password" id="register-password" class="input" placeholder="Contrase√±a">
                    <i class="fa-solid fa-lock"></i>
                </div>
                <button type="button" onclick="register()">Registrar</button>
                <p class="footer">¬øYa tienes una cuenta? <a href="#" class="link" onclick="showSection('login'); return false;">Inicia Sesi√≥n</a></p>
                <div id="register-result" class="alert"></div>
            </form>
        </div>

        <div id="login-section" class="content-section">
            <div class="header">
                <h1 class="wel_text">BIENVENIDO</h1>
                <p class="para">Gesti√≥n de Productos<br />y Entidades<br />MongoDB Atlas</p>
            </div>
            <form class="form">
                <h1 class="title">Inicio</h1>
                <div class="inp">
                    <input type="email" id="login-email" class="input" placeholder="Email" required>
                    <i class="fa-solid fa-envelope"></i>
                </div>
                <div class="inp">
                    <input type="password" id="login-password" class="input" placeholder="Contrase√±a" required>
                    <i class="fa-solid fa-lock"></i>
                </div>
                <button type="button" onclick="login()">Iniciar Sesi√≥n</button>
                <button type="button" class="back" onclick="showSection('register')">Regresar</button>
                <p class="footer">¬øNo tienes una cuenta? <a href="#" class="link" onclick="showSection('register'); return false;">Reg√≠strate</a></p>
                <div id="login-result" class="alert"></div>
            </form>
        </div>

        <div id="productos-section" class="content-section">
            <div class="header">
                <h1 class="wel_text">PRODUCTOS</h1>
                <p class="para">Gesti√≥n de Productos<br />y Entidades<br />MongoDB Atlas</p>
            </div>
            <div class="form product-columns">
                <div class="column create-product">
                    <h1 class="title">Crear Producto</h1>
                    <div class="inp">
                        <input type="text" id="create-product-name" class="input" placeholder="Nombre">
                    </div>
                    <div class="inp">
                        <textarea id="create-product-description" class="input" placeholder="Descripci√≥n (opcional)"></textarea>
                    </div>
                    <div class="inp">
                        <input type="number" id="create-product-price" step="0.01" min="0" class="input" placeholder="Precio">
                    </div>
                    <button type="button" onclick="createProducto()">Crear Producto</button>
                    <div id="create-product-result" class="alert"></div>
                </div>
                <div class="column list-products">
                    <h1 class="title">Lista de Productos</h1>
                    <button type="button" class="back" onclick="initializeProductosTabs()">Actualizar</button>
                    <div class="tabs-container">
                        <div class="tabs" id="productos-tabs"></div>
                        <div class="tabs-content" id="productos-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="entidades-section" class="content-section">
            <div class="header">
                <h1 class="wel_text">ENTIDADES</h1>
                <p class="para">Gesti√≥n de Productos<br />y Entidades<br />MongoDB Atlas</p>
            </div>
            <div class="form product-columns">
                <div class="column create-entity">
                    <h1 class="title">Crear Entidad</h1>
                    <div class="inp">
                        <input type="text" id="entity-collection" class="input" placeholder="Colecci√≥n">
                    </div>
                    <div class="inp">
                        <input type="text" id="entity-name" class="input" placeholder="Nombre del Registro">
                    </div>
                    <div class="inp">
                        <textarea id="create-entity-description" class="input" placeholder="Descripci√≥n (opcional)"></textarea>
                    </div>
                    <button type="button" onclick="createEntidad()">Crear Registro</button>
                    <div id="create-entity-result" class="alert"></div>
                </div>
                <div class="column list-entities">
                    <h1 class="title">Lista de Entidades</h1>
                    <button type="button" class="back" onclick="getEntidades()">Actualizar Lista</button>
                    <div class="tabs-container">
                        <div class="tabs" id="entidades-tabs"></div>
                        <div class="tabs-content" id="entidades-list"></div>
                    </div>
                </div>
                <div class="column scrape-section">
                    <h1 class="title">Scraping de Datos</h1>
                    <div class="inp">
                        <input type="text" id="scrape-url" class="input" placeholder="URL a scrapear">
                    </div>
                    <button type="button" onclick="scrapeWebsite()">Scrapear y Descargar</button>
                    <div id="scrape-result" class="alert"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_PRODUCTOS = "http://127.0.0.1:8000/productos";
        const API_BASE_ENTIDADES = "http://127.0.0.1:8000/entidades";
        let accessToken = localStorage.getItem('accessToken') || null;

        function generateSafeId(name) {
            return name
                .toLowerCase()
                .replace(/\s+/g, '-') // Reemplazar espacios por guiones
                .replace(/[^a-z0-9-]/g, ''); // Eliminar caracteres no alfanum√©ricos
        }

        function showAlert(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `alert alert-${type}`;
            setTimeout(() => element.innerHTML = '', 5000);
        }

        function showTab(section, tabId) {
            console.log(`showTab called with section: ${section}, tabId: ${tabId}`);
            const tabs = document.querySelectorAll(`#${section}-tabs .tab`);
            const contents = document.querySelectorAll(`#${section}-list .tab-content`);

            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));

            const selectedTab = Array.from(tabs).find(tab => tab.getAttribute('data-tab-id') === tabId);
            const selectedContent = document.getElementById(tabId);

            if (selectedTab && selectedContent) {
                selectedTab.classList.add('active');
                selectedContent.classList.add('active');
                console.log(`Tab ${tabId} activated successfully`);
            } else {
                console.error(`Tab or content not found for tabId: ${tabId}`);
            }
        }

        function showSection(section) {
            const registerSection = document.getElementById('register-section');
            const loginSection = document.getElementById('login-section');
            const productosSection = document.getElementById('productos-section');
            const entidadesSection = document.getElementById('entidades-section');
            
            const productosBtn = document.getElementById('productos-btn');
            const entidadesBtn = document.getElementById('entidades-btn');
            productosBtn.classList.remove('active');
            entidadesBtn.classList.remove('active');

            registerSection.classList.remove('active');
            loginSection.classList.remove('active');
            productosSection.classList.remove('active');
            entidadesSection.classList.remove('active');
            
            if (section === 'register') {
                registerSection.classList.add('active');
            } else if (section === 'login') {
                loginSection.classList.add('active');
            } else if (section === 'productos') {
                productosSection.classList.add('active');
                productosBtn.classList.add('active');
                initializeProductosTabs();
            } else if (section === 'entidades') {
                entidadesSection.classList.add('active');
                entidadesBtn.classList.add('active');
                getEntidades();
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function fetchWithRefresh(url, options = {}) {
            options.headers = options.headers || {};
            options.headers['Authorization'] = `Bearer ${accessToken}`;
            
            try {
                const response = await fetch(url, options);
                if (response.status === 401) {
                    const refreshed = await refreshAccessToken();
                    if (refreshed) {
                        options.headers['Authorization'] = `Bearer ${accessToken}`;
                        return await fetch(url, options);
                    }
                    throw new Error('No se pudo renovar el token');
                }
                return response;
            } catch (error) {
                throw error;
            }
        }

        async function checkUser() {
            if (!accessToken) {
                showSection('register');
                document.getElementById('main-nav').style.display = 'none';
                return;
            }

            try {
                const response = await fetchWithRefresh('http://127.0.0.1:8000/users/me');
                if (!response.ok) throw new Error(await response.text());
                const user = await response.json();
                document.getElementById('main-nav').style.display = 'flex';
                document.getElementById('profile-btn').innerHTML = `<i class="fa-solid fa-user"></i> ${user.email.split('@')[0]}`;
                showSection('productos');
            } catch (error) {
                console.error('Error al verificar usuario:', error);
                logout();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            checkUser();
        });

        async function register() {
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();
            
            if (!email || !password) {
                showAlert('register-result', 'Email y contrase√±a son requeridos', 'error');
                return;
            }

            try {
                const response = await fetch('http://127.0.0.1:8000/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                if (!response.ok) throw new Error(await response.text());
                const result = await response.json();
                showAlert('register-result', result.mensaje, 'success');
                showSection('login');
            } catch (error) {
                console.error('Error al registrar:', error);
                showAlert('register-result', `Error: ${error.message}`, 'error');
            }
        }

        async function login() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            
            if (!email || !password) {
                showAlert('login-result', 'Email y contrase√±a son requeridos', 'error');
                return;
            }
            if (!email.includes('@') || !email.includes('.')) {
                showAlert('login-result', 'Formato de email inv√°lido', 'error');
                return;
            }

            try {
                const response = await fetch('http://127.0.0.1:8000/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `username=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Error desconocido al iniciar sesi√≥n');
                }
                const data = await response.json();
                accessToken = data.access_token;
                localStorage.setItem('accessToken', data.access_token);
                localStorage.setItem('refreshToken', data.refresh_token);
                showAlert('login-result', 'Inicio de sesi√≥n exitoso', 'success');
                document.getElementById('main-nav').style.display = 'flex';
                checkUser();
            } catch (error) {
                console.error('Error al iniciar sesi√≥n:', error);
                showAlert('login-result', `Error: ${error.message}`, 'error');
            }
        }

        async function refreshAccessToken() {
            const refreshToken = localStorage.getItem('refreshToken');
            if (!refreshToken) {
                logout();
                return false;
            }

            try {
                const response = await fetch('http://127.0.0.1:8000/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refresh_token: refreshToken })
                });
                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                accessToken = data.access_token;
                localStorage.setItem('accessToken', data.access_token);
                localStorage.setItem('refreshToken', data.refresh_token);
                return true;
            } catch (error) {
                console.error('Error al renovar token:', error);
                logout();
                return false;
            }
        }

        function logout() {
            accessToken = null;
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            document.getElementById('main-nav').style.display = 'none';
            showSection('register');
        }

        async function initializeProductosTabs() {
            const tabsElement = document.getElementById('productos-tabs');
            const listElement = document.getElementById('productos-list');
            listElement.innerHTML = '<p>Selecciona una colecci√≥n para ver los productos.</p>';
            tabsElement.innerHTML = '';

            try {
                const response = await fetchWithRefresh(`${API_BASE_PRODUCTOS}/`, { cache: 'no-store' });
                if (!response.ok) throw new Error(await response.text());
                const productos = await response.json();

                if (!Array.isArray(productos) || productos.length === 0) {
                    tabsElement.innerHTML = '';
                    listElement.innerHTML = '<p>No hay productos registrados</p>';
                    return;
                }

                const productosPorColeccion = {};
                productos.forEach(p => {
                    const coleccion = p.coleccion || 'Sin colecci√≥n';
                    if (!productosPorColeccion[coleccion]) {
                        productosPorColeccion[coleccion] = [];
                    }
                    productosPorColeccion[coleccion].push(p);
                });

                let tabsHtml = '';
                let firstTab = true;
                for (const coleccion of Object.keys(productosPorColeccion)) {
                    const safeColeccion = generateSafeId(coleccion);
                    const tabId = `productos-tab-${safeColeccion}`;
                    tabsHtml += `<button class="tab ${firstTab ? 'active' : ''}" data-tab-id="${tabId}" onclick="loadProductosTab('${coleccion}', '${tabId}')">${coleccion} (${productosPorColeccion[coleccion].length})</button>`;
                    firstTab = false;
                }

                tabsElement.innerHTML = tabsHtml;
            } catch (error) {
                console.error('Error al inicializar pesta√±as de productos:', error);
                showAlert('productos-list', `Error: ${error.message}`, 'error');
            }
        }

        async function loadProductosTab(coleccion, tabId) {
            const listElement = document.getElementById('productos-list');
            listElement.innerHTML = '<p>Cargando...</p>';

            try {
                const response = await fetchWithRefresh(`${API_BASE_PRODUCTOS}/`, { cache: 'no-store' });
                if (!response.ok) throw new Error(await response.text());
                const productos = await response.json();

                const productosPorColeccion = {};
                productos.forEach(p => {
                    const col = p.coleccion || 'Sin colecci√≥n';
                    if (!productosPorColeccion[col]) {
                        productosPorColeccion[col] = [];
                    }
                    productosPorColeccion[col].push(p);
                });

                const items = productosPorColeccion[coleccion] || [];
                let itemsHtml = items.length > 0 ? '' : '<p>No hay productos en esta colecci√≥n</p>';
                items.forEach(p => {
                    const price = p.price !== undefined ? p.price.toFixed(2) : 'No especificado';
                    itemsHtml += `
                        <div class="producto-card">
                            <div>
                                <p><strong>Nombre:</strong> ${p.name || 'Sin nombre'}</p>
                                <p><strong>Descripci√≥n:</strong> ${p.description || 'Sin descripci√≥n'}</p>
                                <p><strong>Precio:</strong> $${price}</p>
                                <p><small>ID: ${p._id || 'Sin ID'}</small></p>
                            </div>
                            <div>
                                <button onclick="editProducto('${p._id}', '${p.name || ''}', '${p.description || ''}', '${p.price || ''}', '${p.coleccion || ''}')">Editar</button>
                                <button class="back" onclick="deleteProducto('${p._id}', '${p.coleccion || ''}')">Eliminar</button>
                            </div>
                        </div>
                    `;
                });

                const contentHtml = `
                    <div id="${tabId}" class="tab-content active">
                        ${itemsHtml}
                    </div>
                `;
                listElement.innerHTML = contentHtml;
                showTab('productos', tabId);
            } catch (error) {
                console.error('Error al cargar productos:', error);
                showAlert('productos-list', `Error: ${error.message}`, 'error');
            }
        }

        async function createProducto() {
            const producto = {
                name: document.getElementById('create-product-name').value.trim(),
                description: document.getElementById('create-product-description').value.trim(),
                price: parseFloat(document.getElementById('create-product-price').value) || 0
            };
            
            if (!producto.name) {
                showAlert('create-product-result', 'Nombre es requerido', 'error');
                return;
            }
            
            try {
                const response = await fetchWithRefresh(`${API_BASE_PRODUCTOS}/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(producto)
                });
                if (!response.ok) throw new Error(await response.text());
                const result = await response.json();
                showAlert('create-product-result', `${result.mensaje}`, 'success');
                document.getElementById('create-product-name').value = '';
                document.getElementById('create-product-description').value = '';
                document.getElementById('create-product-price').value = '';
                initializeProductosTabs();
            } catch (error) {
                console.error('Error al crear producto:', error);
                showAlert('create-product-result', `Error: ${error.message}`, 'error');
            }
        }

        function editProducto(id, name, description, price, coleccion) {
            document.getElementById('create-product-name').value = name;
            document.getElementById('create-product-description').value = description;
            document.getElementById('create-product-price').value = price === 'No especificado' ? '0' : price;
            const createButton = document.querySelector('#create-product-result').previousElementSibling;
            createButton.textContent = 'Actualizar Producto';
            createButton.onclick = () => updateProducto(id, coleccion);
        }

        async function updateProducto(id, coleccion) {
            const producto = {
                name: document.getElementById('create-product-name').value.trim(),
                description: document.getElementById('create-product-description').value.trim(),
                price: parseFloat(document.getElementById('create-product-price').value) || 0
            };
            
            try {
                const response = await fetchWithRefresh(`${API_BASE_PRODUCTOS}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(producto)
                });
                if (!response.ok) throw new Error(await response.text());
                const result = await response.json();
                showAlert('create-product-result', `${result.mensaje}`, 'success');
                document.getElementById('create-product-name').value = '';
                document.getElementById('create-product-description').value = '';
                document.getElementById('create-product-price').value = '';
                const createButton = document.querySelector('#create-product-result').previousElementSibling;
                createButton.textContent = 'Crear Producto';
                createButton.onclick = createProducto;
                initializeProductosTabs();
            } catch (error) {
                console.error('Error al actualizar producto:', error);
                showAlert('create-product-result', `Error: ${error.message}`, 'error');
            }
        }

        async function deleteProducto(id, coleccion) {
            if (!confirm('¬øEst√°s seguro de eliminar este producto?')) return;
            
            console.log(`Intentando eliminar producto con ID: ${id} de la colecci√≥n: ${coleccion}`);
            try {
                const response = await fetchWithRefresh(`${API_BASE_PRODUCTOS}/${id}?coleccion=${encodeURIComponent(coleccion || 'productos')}`, {
                    method: 'DELETE'
                });
                const responseData = await response.json();
                if (!response.ok) {
                    console.error('Respuesta de error del backend:', responseData);
                    throw new Error(responseData.detail || 'Error desconocido al eliminar el producto');
                }
                
                console.log('Respuesta del backend:', responseData);
                showAlert('productos-list', `${responseData.mensaje}`, 'success');
                initializeProductosTabs();
            } catch (error) {
                console.error('Error al eliminar producto:', error.message);
                showAlert('productos-list', `Error: ${error.message}`, 'error');
            }
        }

        async function getEntidades() {
            const tabsElement = document.getElementById('entidades-tabs');
            const listElement = document.getElementById('entidades-list');
            listElement.innerHTML = '<p>Selecciona una colecci√≥n para ver las entidades.</p>';
            tabsElement.innerHTML = '';

            try {
                const responseColecciones = await fetchWithRefresh(`${API_BASE_ENTIDADES}/`);
                if (!responseColecciones.ok) throw new Error(await responseColecciones.text());
                const colecciones = await responseColecciones.json();

                console.log('Colecciones recibidas:', colecciones);

                if (!Array.isArray(colecciones) || colecciones.length === 0) {
                    tabsElement.innerHTML = '';
                    listElement.innerHTML = '<p>No hay colecciones registradas</p>';
                    return;
                }

                let tabsHtml = '';
                for (const coleccion of colecciones) {
                    const responseEntidades = await fetchWithRefresh(`${API_BASE_ENTIDADES}/${coleccion}`);
                    const entidades = await responseEntidades.json();

                    console.log(`Entidades para ${coleccion}:`, entidades);

                    const safeColeccion = generateSafeId(coleccion);
                    const tabId = `entidades-tab-${safeColeccion}`;
                    tabsHtml += `<button class="tab" data-tab-id="${tabId}" onclick="loadEntidadesTab('${coleccion}', '${tabId}')">${coleccion} (${entidades.length})</button>`;
                }

                tabsElement.innerHTML = tabsHtml;
            } catch (error) {
                console.error('Error al obtener colecciones:', error);
                showAlert('entidades-list', `Error: ${error.message}`, 'error');
            }
        }

        async function loadEntidadesTab(coleccion, tabId) {
            const listElement = document.getElementById('entidades-list');
            listElement.innerHTML = '<p>Cargando...</p>';

            try {
                const response = await fetchWithRefresh(`${API_BASE_ENTIDADES}/${coleccion}`);
                if (!response.ok) throw new Error(await response.text());
                const entidades = await response.json();

                let itemsHtml = entidades.length > 0 ? '' : '<p>No hay entidades en esta colecci√≥n</p>';
                entidades.forEach(e => {
                    itemsHtml += `
                        <div>
                            <div>
                                <p><strong>Nombre:</strong> ${e.name || 'Sin nombre'}</p>
                                <p><strong>Descripci√≥n:</strong> ${e.description || 'Sin descripci√≥n'}</p>
                                <p><small>ID: ${e._id}</small></p>
                            </div>
                            <div>
                                <button onclick="editEntidad('${e._id}', '${e.name || ''}', '${e.description || ''}', '${coleccion}')">Editar</button>
                                <button class="back" onclick="deleteEntidad('${e._id}', '${coleccion}')">Eliminar</button>
                            </div>
                        </div>
                    `;
                });

                const contentHtml = `
                    <div id="${tabId}" class="tab-content active">
                        <div class="entidad-chip">
                            ${itemsHtml}
                            <button class="back" onclick="deleteColeccion('${coleccion}')">Eliminar Colecci√≥n</button>
                        </div>
                    </div>
                `;
                listElement.innerHTML = contentHtml;
                showTab('entidades', tabId);
            } catch (error) {
                console.error('Error al cargar entidades:', error);
                showAlert('entidades-list', `Error: ${error.message}`, 'error');
            }
        }

        async function createEntidad() {
            const coleccion = document.getElementById('entity-collection').value.trim().toLowerCase();
            const entidad = {
                name: document.getElementById('entity-name').value.trim(),
                description: document.getElementById('create-entity-description').value.trim()
            };
            
            if (!coleccion || !entidad.name) {
                showAlert('create-entity-result', 'Colecci√≥n y nombre son requeridos', 'error');
                return;
            }
            
            try {
                const response = await fetchWithRefresh(`${API_BASE_ENTIDADES}/${coleccion}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entidad)
                });
                if (!response.ok) throw new Error(await response.text());
                const result = await response.json();
                showAlert('create-entity-result', `${result.mensaje}`, 'success');
                document.getElementById('entity-collection').value = '';
                document.getElementById('entity-name').value = '';
                document.getElementById('create-entity-description').value = '';
                getEntidades();
            } catch (error) {
                console.error('Error al crear entidad:', error);
                showAlert('create-entity-result', `Error: ${error.message}`, 'error');
            }
        }

        function editEntidad(id, name, description, coleccion) {
            document.getElementById('entity-collection').value = coleccion;
            document.getElementById('entity-name').value = name;
            document.getElementById('create-entity-description').value = description;
            const createButton = document.querySelector('#create-entity-result').previousElementSibling;
            createButton.textContent = 'Actualizar Entidad';
            createButton.onclick = () => updateEntidad(id, coleccion);
        }

        async function updateEntidad(id, coleccion) {
            const entidad = {
                name: document.getElementById('entity-name').value.trim(),
                description: document.getElementById('create-entity-description').value.trim()
            };
            
            try {
                const response = await fetchWithRefresh(`${API_BASE_ENTIDADES}/${coleccion}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entidad)
                });
                if (!response.ok) throw new Error(await response.text());
                const result = await response.json();
                showAlert('create-entity-result', `${result.mensaje}`, 'success');
                document.getElementById('entity-collection').value = '';
                document.getElementById('entity-name').value = '';
                document.getElementById('create-entity-description').value = '';
                const createButton = document.querySelector('#create-entity-result').previousElementSibling;
                createButton.textContent = 'Crear Registro';
                createButton.onclick = createEntidad;
                getEntidades();
            } catch (error) {
                console.error('Error al actualizar entidad:', error);
                showAlert('create-entity-result', `Error: ${error.message}`, 'error');
            }
        }

        async function deleteEntidad(id, coleccion) {
            if (!confirm('¬øEst√°s seguro de eliminar esta entidad?')) return;

            console.log(`Intentando eliminar entidad con ID: ${id} de la colecci√≥n: ${coleccion}`);
            try {
                const response = await fetchWithRefresh(`${API_BASE_ENTIDADES}/${coleccion}/${id}`, {
                    method: 'DELETE'
                });
                const responseData = await response.json();
                if (!response.ok) {
                    console.error('Respuesta de error del backend:', responseData);
                    throw new Error(responseData.detail || 'Error desconocido al eliminar la entidad');
                }
                
                console.log('Respuesta del backend:', responseData);
                showAlert('entidades-list', `${responseData.mensaje}`, 'success');
                getEntidades();
            } catch (error) {
                console.error('Error al eliminar entidad:', error.message);
                showAlert('entidades-list', `Error: ${error.message}`, 'error');
            }
        }

        async function deleteColeccion(coleccion) {
            if (!confirm(`¬øEst√°s seguro de eliminar la colecci√≥n "${coleccion}"?`)) return;
            
            try {
                const response = await fetchWithRefresh(`${API_BASE_ENTIDADES}/${coleccion}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error(await response.text());
                const result = await response.json();
                showAlert('entidades-list', `${result.mensaje}`, 'success');
                getEntidades();
            } catch (error) {
                console.error('Error al eliminar colecci√≥n:', error);
                showAlert('entidades-list', `Error: ${error.message}`, 'error');
            }
        }

        async function scrapeWebsite() {
            const url = document.getElementById('scrape-url').value.trim();

            if (!url) {
                showAlert('scrape-result', 'La URL es requerida', 'error');
                return;
            }

            try {
                const response = await fetchWithRefresh(`http://127.0.0.1:8000/scraping/?url=${encodeURIComponent(url)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error(await response.text());

                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition');
                const filenameMatch = contentDisposition && contentDisposition.match(/filename="(.+)"/);
                const filename = filenameMatch ? filenameMatch[1] : 'scraped_data.xlsx';

                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showAlert('scrape-result', 'Datos scrapeados y descargados exitosamente', 'success');
            } catch (error) {
                console.error('Error al scrapear:', error);
                showAlert('scrape-result', `Error: ${error.message}`, 'error');
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93b32faa0dc0b055',t:'MTc0NjQ3OTAyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>