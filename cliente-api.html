<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Entidades - MongoDB Atlas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            color: #fff;
        }

        body {
            width: 100vw;
            min-height: 100vh;
            background: #081b29;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }

        ::-webkit-input-placeholder {
            color: #eee;
        }

        ::-moz-placeholder {
            color: #eee;
        }

        :-ms-input-placeholder {
            color: #eee;
        }

        ::placeholder {
            color: #eee;
        }

        header {
            width: 100%;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 20px;
        }

        .nav-buttons {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .nav-buttons button {
            width: 150px;
            font-size: 18px;
            padding: 10px 0;
            border-radius: 40px;
            background: linear-gradient(45deg, #0ef, #c800ff);
            border: none;
            cursor: pointer;
            transition: transform 0.3s ease, background 0.3s ease, box-shadow 0.3s ease;
        }

        .nav-buttons button:hover {
            transform: scale(1.05);
        }

        .nav-buttons button:active {
            transform: scale(0.95);
        }

        .nav-buttons button.active {
            background: linear-gradient(45deg, #00ff00, #00c4ff);
            box-shadow: 0 0 15px #00ff00, 0 0 30px #00c4ff;
            animation: glow 1.5s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 10px #00ff00, 0 0 20px #00c4ff;
            }
            to {
                box-shadow: 0 0 20px #00ff00, 0 0 40px #00c4ff;
            }
        }

        .user-actions {
            display: flex;
            gap: 15px;
        }

        .user-actions button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 40px;
            border: 2px solid #0ef;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-actions button:hover {
            background: #0ef;
            color: #081b29;
        }

        .user-actions button i {
            font-size: 18px;
        }

        .wrapper {
            position: relative;
            width: 95vw;
            max-width: 1200px;
            border: 3px solid #00ffff;
            box-shadow: 0 0 50px 0 #00a6bc;
            display: flex;
            flex-direction: column;
            height: auto;
            min-height: 60vh;
        }

        #register-section.active .wrapper,
        #login-section.active .wrapper {
            max-width: 450px;
        }

        #register-section.active .form,
        #login-section.active .form {
            padding: 20px;
        }

        #register-section.active .title,
        #login-section.active .title {
            font-size: 24px;
        }

        #register-section.active .inp input,
        #login-section.active .inp input {
            font-size: 16px;
        }

        #register-section.active .header .wel_text,
        #login-section.active .header .wel_text {
            font-size: 36px;
            line-height: 40px;
        }

        #register-section.active .header .para,
        #login-section.active .header .para {
            font-size: 16px;
            line-height: 20px;
        }

        #productos-section.active .form,
        #entidades-section.active .form,
        #cloudwords-section.active .form,
        #lemmatize-section.active .form,
        #rpa-section.active .form,
        #scraping-section.active .form {
            padding: 50px;
        }

        #productos-section.active .title,
        #entidades-section.active .title,
        #cloudwords-section.active .title,
        #lemmatize-section.active .title,
        #rpa-section.active .title,
        #scraping-section.active .title {
            font-size: 36px;
        }

        #productos-section.active .inp input,
        #entidades-section.active .inp input,
        #productos-section.active .inp textarea,
        #entidades-section.active .inp textarea,
        #cloudwords-section.active .inp input,
        #cloudwords-section.active .inp textarea,
        #lemmatize-section.active .inp input,
        #lemmatize-section.active .inp textarea,
        #rpa-section.active .inp input,
        #rpa-section.active .inp textarea,
        #scraping-section.active .inp input,
        #scraping-section.active .inp textarea {
            font-size: 22px;
        }

        #productos-section.active .header .wel_text,
        #entidades-section.active .header .wel_text,
        #cloudwords-section.active .header .wel_text,
        #lemmatize-section.active .header .wel_text,
        #rpa-section.active .header .wel_text,
        #scraping-section.active .header .wel_text {
            font-size: 52px;
            line-height: 56px;
        }

        #productos-section.active .header .para,
        #entidades-section.active .header .para,
        #cloudwords-section.active .header .para,
        #lemmatize-section.active .header .para,
        #rpa-section.active .header .para,
        #scraping-section.active .header .para {
            font-size: 22px;
            line-height: 26px;
        }

        .header {
            background: linear-gradient(to right, #0ef, #c800ff);
            clip-path: polygon(0 0, 100% 0, 100% 80%, 0 100%);
            padding: 20px;
            text-align: center;
        }

        .header .wel_text {
            font-size: 48px;
            line-height: 50px;
        }

        .header .para {
            margin-top: 10px;
            font-size: 20px;
            line-height: 24px;
            letter-spacing: 1px;
        }

        .form {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            height: auto;
            min-height: 300px;
        }

        #productos-section .form, 
        #entidades-section .form,
        #cloudwords-section .form,
        #lemmatize-section .form,
        #rpa-section .form,
        #scraping-section .form {
            justify-content: start;
        }

        .title {
            font-size: 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        .inp {
            position: relative;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
            width: 100%;
        }

        .inp input, .inp textarea, .inp select {
            border: none;
            outline: none;
            background: none;
            width: 100%;
            padding-right: 40px;
            font-size: 18px;
            color: #0ef;
        }

        .inp textarea {
            min-height: 120px;
            resize: vertical;
        }

        .inp i {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #0ef;
            font-size: 18px;
        }

        button {
            border: none;
            outline: none;
            width: 100%;
            margin-top: 20px;
            padding: 12px 0;
            font-size: 20px;
            border-radius: 40px;
            letter-spacing: 1px;
            cursor: pointer;
            background: linear-gradient(45deg, #0ef, #c800ff);
            transition: transform 0.3s ease;
        }

        button:hover {
            transform: scale(1.05);
        }

        button:active {
            transform: scale(0.95);
        }

        button.back {
            background: transparent;
            border: 2px solid #0ef;
            margin-top: 25px;
            width: 300px;
            font-size: 22px;
        }

        button.back:hover {
            background: #0ef;
            color: #081b29;
        }

        .footer {
            margin-top: 30px;
            letter-spacing: 0.5px;
            font-size: 16px;
            text-align: center;
        }

        .link {
            color: #0ef;
            text-decoration: none;
        }

        .link:hover {
            text-decoration: underline;
        }

        .content-section {
            display: none;
            flex: 1;
            flex-direction: column;
            height: auto;
        }

        .content-section.active {
            display: flex;
        }

        .alert {
            padding: 12px 15px;
            margin-top: 15px;
            font-size: 16px;
            text-align: center;
            width: 100%;
        }

        .alert-success {
            color: #27ae60;
        }

        .alert-error {
            color: #e74c3c;
        }

        #productos-list, #entidades-list {
            margin-top: 15px;
            width: 100%;
        }

        .producto-card, .entidad-chip {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .entidad-chip {
            background: none;
            padding: 0;
        }

        .entidad-chip > div {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            border-top: none;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .entidad-chip > button.back {
            grid-column: 1 / -1;
            width: 100%;
            max-width: 300px;
            margin: 20px auto 0;
        }

        .producto-card p, .entidad-chip p {
            margin: 8px 0;
            font-size: 18px;
        }

        .producto-card strong, .entidad-chip strong {
            color: #0ef;
        }

        .producto-card small, .entidad-chip small {
            color: #eee;
            font-size: 16px;
        }

        .producto-card button, .entidad-chip button {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            width: 100%;
        }

        .entidad-chip > span {
            font-size: 22px;
            font-weight: 500;
            color: #0ef;
            display: block;
            margin-bottom: 15px;
        }

        .product-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 50px;
            padding: 50px;
            width: 100%;
            height: auto;
            align-items: start;
        }

        .column {
            display: flex;
            flex-direction: column;
            align-items: start;
            width: 100%;
        }

        .create-product, .list-products, .create-entity, .list-entities, .scrape-section {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #00ffff;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .list-products #productos-list, .list-entities #entidades-list {
            margin-top: 10px;
            width: 100%;
        }

        .create-product .inp,
        .list-products .inp,
        .create-entity .inp,
        .list-entities .inp,
        .scrape-section .inp,
        .create-product button,
        .list-products button,
        .create-entity button,
        .list-entities button,
        .scrape-section button {
            width: 100%;
            max-width: none;
        }

        .list-products .alert, .list-entities .alert, .scrape-section .alert {
            width: 100%;
            max-width: none;
        }

        .tabs-container {
            display: flex;
            width: 100%;
            margin-top: 20px;
            gap: 20px;
        }

        .tabs {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 200px;
        }

        .tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #0ef;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            text-align: left;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tab.active {
            background: linear-gradient(45deg, #0ef, #c800ff);
            border-color: #00ff00;
            box-shadow: 0 0 10px #0ef;
        }

        .tabs-content {
            flex: 1;
            width: 100%;
        }

        .tab-content {
            display: none;
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .tab-content.active {
            display: grid;
        }

        /* NUEVOS ESTILOS OAUTH */
        .oauth-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
            width: 100%;
        }
        
        .oauth-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 8px;
            border: 2px solid;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            width: 100%;
            box-sizing: border-box;
            margin-top: 0;
        }
        
        .oauth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .oauth-btn i {
            font-size: 20px;
        }
        
        .oauth-btn.google {
            background: #fff;
            border-color: #db4437;
            color: #db4437;
        }
        
        .oauth-btn.google:hover {
            background: #db4437;
            color: #fff;
        }
        
        
        
               
                
        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #ccc;
        }
        
        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #ccc;
        }
        
        .divider span {
            padding: 0 15px;
            font-size: 14px;
        }
        
        .oauth-success-message {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4CAF50;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #4CAF50;
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .oauth-error-message {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid #f44336;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #f44336;
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .connected-accounts {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid #0ef;
        }
        
        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .account-item:last-child {
            border-bottom: none;
        }
        
        .account-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .account-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .account-status.connected {
            background: #4CAF50;
            color: white;
        }
        
        .account-status.disconnected {
            background: #757575;
            color: white;
        }
        
        .unlink-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid #f44336;
            color: #f44336;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            width: auto;
            margin-top: 0;
        }
        
        .unlink-btn:hover {
            background: #f44336;
            color: white;
        }

        /* RPA SECTION FIXES */
        .wrapper, #rpa-section .wrapper {
            position: static !important;
            width: auto !important;
            border: none !important;
            box-shadow: none !important;
            background: none !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* REEMPLAZAR ESTA SECCI√ìN CSS PROBLEM√ÅTICA */
/* CSS CORREGIDO PARA RPA */
#rpa-section {
    border: none !important;
    box-shadow: none !important;
    background: #081b29 !important;
    margin: 0 !important;
    padding: 0 !important;
    position: relative !important;
    /* ELIMINADAS LAS L√çNEAS PROBLEM√ÅTICAS DE POSICIONAMIENTO */
}

#rpa-section .header {
    background: linear-gradient(to right, #0ef, #c800ff);
    clip-path: polygon(0 0, 100% 0, 100% 80%, 0 100%);
    padding: 20px;
    text-align: center;
    margin: 0 !important;
    /* ELIMINADA LA L√çNEA top: -70px PROBLEM√ÅTICA */
}

#rpa-section .wel_text {
    margin: 0 !important;
    padding: 0 !important;
    font-size: 48px !important;
    line-height: 50px !important;
    display: block !important;
    visibility: visible !important;
    color: white !important;
}

#rpa-section .para {
    display: block !important;
    visibility: visible !important;
    margin-top: 10px !important;
    font-size: 20px !important;
    color: white !important;
}

#rpa-section .form {
    border: none !important;
    box-shadow: none !important;
    background: none !important;
    padding: 30px !important;
    margin-top: 0 !important;
    position: relative !important;
    z-index: 90 !important;
}

#rpa-section .create-product {
    background: rgba(0, 0, 0, 0.2) !important;
    border-radius: 15px !important;
    padding: 20px !important;
    border: 1px solid rgba(0, 255, 255, 0.1) !important;
    box-shadow: none !important;
    margin-top: 10px !important;
    position: relative !important;
    z-index: 100 !important;
    max-width: 600px;
    margin: 10px auto 0;
}

#rpa-section .title {
    margin-top: 0 !important;
    margin-bottom: 15px !important;
    font-size: 24px !important;
    display: block !important;
    visibility: visible !important;
    color: #0ef !important;
    text-align: center !important;
}

        h1, h2, h3, .title, .wel_text, .para {
            display: block !important;
            visibility: visible !important;
        }

        @media (max-width: 768px) {
            .tabs-container {
                flex-direction: column;
            }

            .tabs {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
                white-space: nowrap;
            }

            .tab {
                flex: 0 0 auto;
            }

            .tabs-content {
                width: 100%;
            }

            .tab-content {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }

            .product-columns {
                grid-template-columns: 1fr;
            }

            .oauth-buttons {
                gap: 10px;
            }

            .oauth-btn {
                padding: 10px 15px;
                font-size: 14px;
            }
        }

        #main-nav {
            display: none;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header id="main-nav">
        <div class="nav-buttons">
            <!-- Bot√≥n Productos eliminado -->
            <button id="entidades-btn" onclick="showSection('entidades')">Entidades</button>
            <button id="scraping-btn" onclick="showSection('scraping')">Scraping</button>
            <button id="cloudwords-btn" onclick="showSection('cloudwords')">Nube Palabras</button>
            <button id="lemmatize-btn" onclick="showSection('lemmatize')">Lematizaci√≥n</button>
            <button id="rpa-btn" onclick="showSection('rpa')">RPA</button>
        </div>
        <div class="user-actions">
            <button id="profile-btn"><i class="fa-solid fa-user"></i> Admin</button>
            <button onclick="logout()"><i class="fa-solid fa-sign-out-alt"></i> Cerrar Sesi√≥n</button>
        </div>
    </header>

    <div class="wrapper">
        <!-- SECCI√ìN DE REGISTRO -->
        <div id="register-section" class="content-section">
            <div class="header">
                <h1 class="wel_text">BIENVENIDO</h1>
                <p class="para">Gesti√≥n de Productos<br />y Entidades<br />MongoDB Atlas</p>
            </div>
            <form class="form">
                <h1 class="title">Registro</h1>
                
                <!-- Mensajes OAuth -->
                <div id="oauth-success-message" class="oauth-success-message">
                    <i class="fa-solid fa-check-circle"></i>
                    <span>¬°Inicio de sesi√≥n exitoso!</span>
                </div>
                <div id="oauth-error-message" class="oauth-error-message">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    <span>Error en la autenticaci√≥n</span>
                </div>
                
                <!-- Botones OAuth -->
                <div class="oauth-buttons">
                    <button type="button" class="oauth-btn google" onclick="loginWithProvider('google')">
                        <i class="fab fa-google"></i>
                        Continuar con Google
                    </button>
                    
                </div>
                
                <div class="divider">
                    <span>o registrarse con email</span>
                </div>
                
                <div class="inp">
                    <input type="email" id="register-email" class="input" placeholder="Email">
                    <i class="fa-solid fa-envelope"></i>
                </div>
                <div class="inp">
                    <input type="password" id="register-password" class="input" placeholder="Contrase√±a">
                    <i class="fa-solid fa-lock"></i>
                </div>
                <button type="button" onclick="register()">Registrar</button>
                <p class="footer">¬øYa tienes una cuenta? <a href="#" class="link" onclick="showSection('login'); return false;">Inicia Sesi√≥n</a></p>
                <div id="register-result" class="alert"></div>
            </form>
        </div>

        <!-- SECCI√ìN DE LOGIN -->
        <div id="login-section" class="content-section">
            <div class="header">
                <h1 class="wel_text">BIENVENIDO</h1>
                <p class="para">Gesti√≥n de Productos<br />y Entidades<br />MongoDB Atlas</p>
            </div>
            <form class="form">
                <h1 class="title">Inicio de Sesi√≥n</h1>
                
                <!-- Mensajes OAuth -->
                <div id="login-oauth-success" class="oauth-success-message">
                    <i class="fa-solid fa-check-circle"></i>
                    <span>¬°Inicio de sesi√≥n exitoso!</span>
                </div>
                <div id="login-oauth-error" class="oauth-error-message">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    <span>Error en la autenticaci√≥n</span>
                </div>
                
                <!-- Botones OAuth -->
                <div class="oauth-buttons">
                    <button type="button" class="oauth-btn google" onclick="loginWithProvider('google')">
                        <i class="fab fa-google"></i>
                        Continuar con Google
                    </button>
                    
                </div>
                
                <div class="divider">
                    <span>o iniciar sesi√≥n con email</span>
                </div>
                
                <div class="inp">
                    <input type="email" id="login-email" class="input" placeholder="Email" required>
                    <i class="fa-solid fa-envelope"></i>
                </div>
                <div class="inp">
                    <input type="password" id="login-password" class="input" placeholder="Contrase√±a" required>
                    <i class="fa-solid fa-lock"></i>
                </div>
                <button type="button" onclick="login()">Iniciar Sesi√≥n</button>
                <button type="button" class="back" onclick="showSection('register')">Regresar</button>
                <p class="footer">¬øNo tienes una cuenta? <a href="#" class="link" onclick="showSection('register'); return false;">Reg√≠strate</a></p>
                <div id="login-result" class="alert"></div>
            </form>
        </div>

        

        <!-- SECCI√ìN DE ENTIDADES -->
        <div id="entidades-section" class="content-section">
            <div class="header">
                <h1 class="wel_text">ENTIDADES</h1>
                <p class="para">Gesti√≥n de Productos<br />y Entidades<br />MongoDB Atlas</p>
            </div>
            <div class="form product-columns">
                <div class="column create-entity">
                    <h1 class="title">Crear Entidad</h1>
                    <div class="inp">
                        <input type="text" id="entity-collection" class="input" placeholder="Colecci√≥n">
                    </div>
                    <div class="inp">
                        <input type="text" id="entity-name" class="input" placeholder="Nombre del Registro">
                    </div>
                    <div class="inp">
                        <textarea id="create-entity-description" class="input" placeholder="Descripci√≥n (opcional)"></textarea>
                    </div>
                    <button type="button" onclick="createEntidad()">Crear Registro</button>
                    <div id="create-entity-result" class="alert"></div>
                </div>
                <div class="column list-entities">
                    <h1 class="title">Lista de Entidades</h1>
                    <button type="button" class="back" onclick="getEntidades()">Actualizar Lista</button>
                    <div class="tabs-container">
                        <div class="tabs" id="entidades-tabs"></div>
                        <div class="tabs-content" id="entidades-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN DE SCRAPING -->
        <div id="scraping-section" class="content-section">
            <div class="header">
                <h1 class="wel_text">SCRAPING DE DATOS</h1>
                <p class="para">Extracci√≥n de Informaci√≥n<br />de Sitios Web<br />MongoDB Atlas</p>
            </div>
            <div class="form">
                <div class="create-product" style="width: 100%; max-width: 800px; margin: 0 auto;">
                    <h1 class="title">Scraping de Datos</h1>
                    <div class="inp">
                        <input type="text" id="scrape-url" class="input" placeholder="URL a scrapear">
                    </div>
                    <button type="button" onclick="scrapeWebsite()">Scrapear y Descargar</button>
                    <div id="scrape-result" class="alert"></div>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN DE NUBE DE PALABRAS -->
        <div id="cloudwords-section" class="content-section">
            <div class="header">
                <h1 class="wel_text">NUBE DE PALABRAS</h1>
                <p class="para">An√°lisis de Textos<br />y Colecciones<br />MongoDB Atlas</p>
            </div>
            <div class="form">
                <div class="create-product" style="width: 100%; max-width: 800px; margin: 0 auto;">
                    <h1 class="title">Generar Nube de Palabras</h1>
                    <div class="inp">
                        <textarea id="cloudwords-text" class="input" placeholder="Escribe o pega el texto para analizar" rows="8"></textarea>
                    </div>
                    <button type="button" onclick="generateWordcloud()">Generar Nube de Palabras</button>
                    <div id="cloudwords-result" class="alert"></div>
                    <div id="cloudwords-result-container"></div>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN DE LEMATIZACI√ìN -->
        <div id="lemmatize-section" class="content-section">
            <div class="header">
                <h1 class="wel_text">LEMATIZACI√ìN</h1>
                <p class="para">An√°lisis de Textos<br />MongoDB Atlas</p>
            </div>
            <div class="form">
                <div class="create-product" style="width: 100%; max-width: 800px; margin: 0 auto;">
                    <h1 class="title">Lematizar Texto</h1>
                    <div class="inp">
                        <textarea id="lemmatize-text" class="input" placeholder="Escribe o pega el texto para lematizar" rows="6"></textarea>
                    </div>
                    <div class="inp">
                        <select id="lemmatize-language" class="input">
                            <option value="spanish">Espa√±ol</option>
                            <option value="english">Ingl√©s</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <input type="checkbox" id="lemmatize-remove-stopwords" checked style="margin-right: 10px; width: auto;">
                        <label for="lemmatize-remove-stopwords" style="color: #0ef;">Eliminar stopwords</label>
                    </div>
                    <button type="button" onclick="lemmatizeText()">Lematizar Texto</button>
                    <div id="lemmatize-result" class="alert"></div>
                    <div id="lemmatize-result-container"></div>
                </div>
            </div>
        </div>

        <!-- SECCI√ìN RPA -->
        <div id="rpa-section" class="content-section">
            <div class="header">
                <h1 class="wel_text">AUTOMATIZACI√ìN (RPA)</h1>
                <p class="para">Robotic Process Automation</p>
            </div>
            <div class="form" style="border: none !important; box-shadow: none !important;">
                <div class="create-product" style="width: 100%; max-width: 600px; margin: 0 auto; border: none; box-shadow: none;">
                    <h1 class="title">Automatizaci√≥n de Office</h1>
                    
                    <div style="background: rgba(14, 255, 255, 0.1); border-radius: 10px; padding: 10px; margin-bottom: 20px; border-left: 3px solid #0ef;">
                        <p style="margin: 0; color: #0ef;">
                            <i class="fa-solid fa-info-circle"></i> 
                            <strong>Importante:</strong> Durante el proceso se abrir√° la aplicaci√≥n seleccionada. <strong>No cierres ni interact√∫es</strong> con la aplicaci√≥n hasta que termine la automatizaci√≥n.
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 30px; text-align: center;">
                        <h3 style="color: #0ef; margin-bottom: 20px; font-size: 20px;">Seleccione la aplicaci√≥n para automatizar:</h3>
                        <div style="display: flex; justify-content: center; gap: 40px; margin-bottom: 20px;">
                            <div style="text-align: center;">
                                <input type="radio" id="office-excel" name="office-app" value="excel" style="transform: scale(1.5); margin-bottom: 10px;">
                                <br>
                                <label for="office-excel" style="color: #0ef; font-size: 18px;">Excel</label>
                            </div>
                            <div style="text-align: center;">
                                <input type="radio" id="office-word" name="office-app" value="word" checked style="transform: scale(1.5); margin-bottom: 10px;">
                                <br>
                                <label for="office-word" style="color: #0ef; font-size: 18px; font-weight: bold;">Word</label>
                            </div>
                            <div style="text-align: center;">
                                <input type="radio" id="office-powerpoint" name="office-app" value="powerpoint" style="transform: scale(1.5); margin-bottom: 10px;">
                                <br>
                                <label for="office-powerpoint" style="color: #0ef; font-size: 18px;">PowerPoint</label>
                            </div>
                        </div>
                        <div style="background: rgba(0, 238, 255, 0.1); display: inline-block; padding: 5px 15px; border-radius: 20px;">
                            <span style="color: #0ef; font-size: 14px;">Word preseleccionado para mayor visibilidad del proceso</span>
                        </div>
                    </div>
                    
                    <div class="inp">
                        <input type="text" id="office-file-path" class="input" placeholder="Nombre del archivo (se guardar√° en el Escritorio)">
                        <small style="display: block; margin-top: 5px; color: #0ef;">Ejemplo: documento_word.docx (No necesita colocar ruta completa)</small>
                    </div>
                    
                    <div style="background: rgba(0, 255, 128, 0.05); border-radius: 10px; padding: 12px; margin: 15px 0; border-left: 3px solid #0ef;">
                        <p style="margin: 0; color: #0ef;">
                            <i class="fa-solid fa-folder-open"></i> 
                            <strong>Nota:</strong> Todos los archivos se guardar√°n en su carpeta de Escritorio, independientemente de la ruta ingresada.
                        </p>
                    </div>
                    
                    <div id="excel-params" style="margin-top: 20px; display: none;">
                        <h3 style="color: #0ef; margin-bottom: 10px;">Opciones de Excel:</h3>
                        <div class="inp">
                            <input type="text" id="excel-sheet-name" class="input" placeholder="Nombre de la hoja (opcional)">
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button type="button" onclick="toggleAdvancedOptions()" style="background: none; border: 1px solid #0ef; color: #0ef; padding: 8px 15px; border-radius: 5px; cursor: pointer; width: auto; margin: 0;">
                            <i class="fa-solid fa-cog"></i> Opciones avanzadas
                        </button>
                        
                        <div id="advanced-options" style="display: none; margin-top: 15px; background: rgba(0,0,0,0.1); padding: 15px; border-radius: 10px;">
                            <div style="margin-bottom: 15px;">
                                <label for="visible-process-checkbox" style="display: flex; align-items: center; color: #0ef; cursor: pointer;">
                                    <input type="checkbox" id="visible-process-checkbox" checked style="margin-right: 10px; transform: scale(1.2);">
                                    <span>Mostrar proceso en pantalla (ver c√≥mo se abre y usa la aplicaci√≥n)</span>
                                </label>
                            </div>
                            
                            <div>
                                <label for="slow-mode-checkbox" style="display: flex; align-items: center; color: #0ef; cursor: pointer;">
                                    <input type="checkbox" id="slow-mode-checkbox" checked style="margin-right: 10px; transform: scale(1.2);">
                                    <span>Modo lento (mejor para ver cada paso)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="office-automation-progress" style="display: none; margin-top: 20px; background: rgba(0,0,0,0.2); border-radius: 10px; padding: 15px;">
                        <h3 style="color: #0ef; margin-bottom: 10px;">Progreso:</h3>
                        <div id="progress-steps" style="margin-left: 20px;">
                            <p id="step1" style="margin: 8px 0; color: #aaa;"><i class="fa-solid fa-circle-notch"></i> Iniciando aplicaci√≥n...</p>
                            <p id="step2" style="margin: 8px 0; color: #aaa;"><i class="fa-solid fa-circle-notch"></i> Creando documento...</p>
                            <p id="step3" style="margin: 8px 0; color: #aaa;"><i class="fa-solid fa-circle-notch"></i> Guardando archivo...</p>
                            <p id="step4" style="margin: 8px 0; color: #aaa;"><i class="fa-solid fa-circle-notch"></i> Finalizando proceso...</p>
                        </div>
                        <div style="background: rgba(14, 255, 255, 0.05); border-radius: 5px; padding: 8px; margin-top: 15px; font-size: 14px; color: #0ef; text-align: center;">
                            <i class="fa-solid fa-info-circle"></i> Es posible que necesites cambiar a la ventana de Office que se abrir√° durante el proceso.
                        </div>
                    </div>
                    
                    <button type="button" id="execute-rpa-btn" onclick="executeSimplifiedRPA()" style="margin-top: 30px; height: 60px; font-size: 22px; background: linear-gradient(45deg, #0ef, #c800ff);">
                        Ejecutar Automatizaci√≥n de Office
                    </button>
                    
                    <div id="office-automation-result" class="alert"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_PRODUCTOS = "http://127.0.0.1:8000/productos";
        const API_BASE_ENTIDADES = "http://127.0.0.1:8000/entidades";
        let accessToken = localStorage.getItem('accessToken') || null;

        // ===== FUNCIONES OAUTH =====
        async function loginWithProvider(provider) {
            try {
                showAlert('login-result', `Redirigiendo a ${provider}...`, 'success');
                
                const response = await fetch(`http://127.0.0.1:8000/auth/${provider}/login`);
                if (!response.ok) {
                    throw new Error(`Error al obtener URL de autorizaci√≥n: ${response.statusText}`);
                }
                
                const data = await response.json();
                window.location.href = data.auth_url;
                
            } catch (error) {
                console.error(`Error en login con ${provider}:`, error);
                showAlert('login-result', `Error: ${error.message}`, 'error');
            }
        }

     function handleOAuthCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const oauthSuccess = urlParams.get('oauth_success');
    const oauthError = urlParams.get('oauth_error');  // ‚Üê ESTA L√çNEA FALTABA
    const accessTokenParam = urlParams.get('access_token');
    const refreshTokenParam = urlParams.get('refresh_token');
    const provider = urlParams.get('provider');
    const userName = urlParams.get('user_name');

    console.log('OAuth callback - Access token:', accessTokenParam ? 'Recibido' : 'No recibido');
    console.log('OAuth callback - Refresh token:', refreshTokenParam ? 'Recibido' : 'No recibido');

    if (oauthSuccess === 'true' && accessTokenParam && refreshTokenParam) {
        accessToken = accessTokenParam;
        localStorage.setItem('accessToken', accessTokenParam);
        localStorage.setItem('refreshToken', refreshTokenParam);
        
        const successMessage = document.getElementById('oauth-success-message');
        if (successMessage) {
            const successSpan = successMessage.querySelector('span');
            successSpan.textContent = `¬°Bienvenido ${userName}! Autenticado con ${provider}`;
            successMessage.style.display = 'flex';
        }
        
        document.getElementById('main-nav').style.display = 'flex';
        const profileBtn = document.getElementById('profile-btn');
        if (profileBtn) {
            profileBtn.innerHTML = `<i class="fa-solid fa-user"></i> ${userName || 'Usuario'}`;
        }
        
        setTimeout(() => {
            showSection('productos');
            history.replaceState({}, document.title, window.location.pathname);
        }, 2000);
        
    } else if (oauthError) {  // ‚Üê ESTA VARIABLE AHORA EST√Å DEFINIDA
        const errorMessage = document.getElementById('oauth-error-message');
        if (errorMessage) {
            const errorSpan = errorMessage.querySelector('span');
            errorSpan.textContent = `Error: ${decodeURIComponent(oauthError)}`;
            errorMessage.style.display = 'flex';
        }
        
        setTimeout(() => {
            if (errorMessage) errorMessage.style.display = 'none';
        }, 5000);
        
        history.replaceState({}, document.title, window.location.pathname);
    }
}

       
      
        

       

        // ===== FUNCIONES PRINCIPALES =====
        function generateSafeId(name) {
            return name
                .toLowerCase()
                .replace(/\s+/g, '-')
                .replace(/[^a-z0-9-]/g, '');
        }

        function showAlert(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `alert alert-${type}`;
            setTimeout(() => element.innerHTML = '', 5000);
        }

        function showTab(section, tabId) {
            console.log(`showTab called with section: ${section}, tabId: ${tabId}`);
            const tabs = document.querySelectorAll(`#${section}-tabs .tab`);
            const contents = document.querySelectorAll(`#${section}-list .tab-content`);

            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));

            const selectedTab = Array.from(tabs).find(tab => tab.getAttribute('data-tab-id') === tabId);
            const selectedContent = document.getElementById(tabId);

            if (selectedTab && selectedContent) {
                selectedTab.classList.add('active');
                selectedContent.classList.add('active');
                console.log(`Tab ${tabId} activated successfully`);
            } else {
                console.error(`Tab or content not found for tabId: ${tabId}`);
            }
        }

    function showSection(section) {
    // Todas las secciones
    const sections = {
        register: document.getElementById('register-section'),
        login: document.getElementById('login-section'),
        entidades: document.getElementById('entidades-section'),
        scraping: document.getElementById('scraping-section'),
        cloudwords: document.getElementById('cloudwords-section'),
        lemmatize: document.getElementById('lemmatize-section'),
        rpa: document.getElementById('rpa-section')
    };

    // Ocultar todas las secciones
    Object.values(sections).forEach(sec => sec.classList.remove('active'));
    
    // Mostrar solo la secci√≥n solicitada
    if (sections[section]) {
        sections[section].classList.add('active');
        
        // Ocultar barra de navegaci√≥n en login/register
        if (section === 'register' || section === 'login') {
            document.getElementById('main-nav').style.display = 'none';
        }
    }
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
        async function fetchWithRefresh(url, options = {}) {
    options.headers = options.headers || {};
    if (accessToken) {
        options.headers['Authorization'] = `Bearer ${accessToken}`;
        console.log('Token enviado:', accessToken.substring(0, 20) + '...');
    } else {
        console.log('No hay token disponible');
    }
    
    try {
        console.log('Haciendo petici√≥n a:', url);
        const response = await fetch(url, options);
        console.log('Respuesta status:', response.status);
        
        if (response.status === 401) {
            console.log("Token expirado, intentando renovar...");
            const refreshed = await refreshAccessToken();
            if (refreshed) {
                options.headers['Authorization'] = `Bearer ${accessToken}`;
                console.log('Token renovado, reintentando...');
                return await fetch(url, options);
            }
            showSection('login');
            throw new Error('Sesi√≥n expirada. Por favor inicie sesi√≥n nuevamente.');
        }
        return response;
    } catch (error) {
        console.error("Error en fetchWithRefresh:", error);
        throw error;
    }
}

        async function login() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            
            if (!email || !password) {
                showAlert('login-result', 'Email y contrase√±a son requeridos', 'error');
                return;
            }
            if (!email.includes('@') || !email.includes('.')) {
                showAlert('login-result', 'Formato de email inv√°lido', 'error');
                return;
            }

            try {
                showAlert('login-result', 'Iniciando sesi√≥n...', 'success');
                
                const response = await fetch('http://127.0.0.1:8000/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `username=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.detail || 'Error desconocido al iniciar sesi√≥n';
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                accessToken = data.access_token;
                localStorage.setItem('accessToken', data.access_token);
                localStorage.setItem('refreshToken', data.refresh_token);
                showAlert('login-result', 'Inicio de sesi√≥n exitoso', 'success');
                document.getElementById('main-nav').style.display = 'flex';
                checkUser();
            } catch (error) {
                console.error('Error al iniciar sesi√≥n:', error);
                showAlert('login-result', `Error: ${error.message}`, 'error');
            }
        }

     async function checkUser() {
    // Ocultar barra de navegaci√≥n inicialmente
    document.getElementById('main-nav').style.display = 'none';
    
    // Verificar si hay token
    if (!accessToken) {
        showSection('register'); // Forzar mostrar registro
        return;
    }

    try {
        const response = await fetchWithRefresh('http://127.0.0.1:8000/users/me');
        const user = await response.json();
        
        // Mostrar barra de navegaci√≥n solo si est√° autenticado
        document.getElementById('main-nav').style.display = 'flex';
        document.getElementById('profile-btn').innerHTML = `<i class="fa-solid fa-user"></i> ${user.email.split('@')[0]}`;
        
        showSection('entidades');
        
    } catch (error) {
        console.error('Error:', error);
        logout();
        showSection('register'); // Mostrar registro si falla la verificaci√≥n
    }
}

        async function register() {
            const email = document.getElementById('register-email').value.trim();
            const password = document.getElementById('register-password').value.trim();
            
            if (!email || !password) {
                showAlert('register-result', 'Email y contrase√±a son requeridos', 'error');
                return;
            }

            try {
                const response = await fetch('http://127.0.0.1:8000/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                if (!response.ok) throw new Error(await response.text());
                const result = await response.json();
                showAlert('register-result', result.mensaje, 'success');
                showSection('login');
            } catch (error) {
                console.error('Error al registrar:', error);
                showAlert('register-result', `Error: ${error.message}`, 'error');
            }
        }

    async function refreshAccessToken() {
    const refreshToken = localStorage.getItem('refreshToken');
    console.log('Refresh token disponible:', refreshToken ? 'S√≠' : 'No');
    
    if (!refreshToken) {
        console.log('No hay refresh token, redirigiendo a login');
        logout();
        return false;
    }

    try {
        console.log('Intentando renovar token...');
        const response = await fetch('http://127.0.0.1:8000/refresh', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ refresh_token: refreshToken })
        });
        
        if (!response.ok) {
            console.log('Error al renovar token:', response.status);
            const errorText = await response.text();
            console.log('Error details:', errorText);
            throw new Error(errorText);
        }
        
        const data = await response.json();
        accessToken = data.access_token;
        localStorage.setItem('accessToken', data.access_token);
        localStorage.setItem('refreshToken', data.refresh_token);
        console.log('Token renovado exitosamente');
        return true;
    } catch (error) {
        console.error('Error al renovar token:', error);
        logout();
        return false;
    }
}

        function logout() {
            accessToken = null;
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            document.getElementById('main-nav').style.display = 'none';
            showSection('register');
        }

        // ===== FUNCIONES DE PRODUCTOS =====
        let isLoadingProducts = false;

       async function initializeProductosTabs() {
    console.log('Iniciando initializeProductosTabs...');
    
    const tabsElement = document.getElementById('productos-tabs');
    const listElement = document.getElementById('productos-list');
    
    // Verificar que los elementos existen
    if (!tabsElement) {
        console.error('No se encontr√≥ el elemento productos-tabs');
        return;
    }
    if (!listElement) {
        console.error('No se encontr√≥ el elemento productos-list');
        return;
    }
    
    listElement.innerHTML = '<p>Selecciona una colecci√≥n para ver los productos.</p>';
    tabsElement.innerHTML = '';

    try {
        console.log('Haciendo petici√≥n a productos...');
        const response = await fetchWithRefresh(`${API_BASE_PRODUCTOS}/`, { cache: 'no-store' });
        
        if (!response.ok) throw new Error(await response.text());
        const productos = await response.json();

        if (!Array.isArray(productos) || productos.length === 0) {
            tabsElement.innerHTML = '';
            listElement.innerHTML = '<p>No hay productos registrados</p>';
            return;
        }

        const productosPorColeccion = {};
        productos.forEach(p => {
            const coleccion = p.coleccion || 'Sin colecci√≥n';
            if (!productosPorColeccion[coleccion]) {
                productosPorColeccion[coleccion] = [];
            }
            productosPorColeccion[coleccion].push(p);
        });

        let tabsHtml = '';
        let firstTab = true;
        for (const coleccion of Object.keys(productosPorColeccion)) {
            const safeColeccion = generateSafeId(coleccion);
            const tabId = `productos-tab-${safeColeccion}`;
            tabsHtml += `<button class="tab ${firstTab ? 'active' : ''}" data-tab-id="${tabId}" onclick="loadProductosTab('${coleccion}', '${tabId}')">${coleccion} (${productosPorColeccion[coleccion].length})</button>`;
            firstTab = false;
        }

        tabsElement.innerHTML = tabsHtml;
        console.log('Productos cargados exitosamente');
        
    } catch (error) {
        console.error('Error al inicializar pesta√±as de productos:', error);
        showAlert('productos-list', `Error: ${error.message}`, 'error');
    }
}
            
            
            
        
        

        async function loadProductosTab(coleccion, tabId) {
            const listElement = document.getElementById('productos-list');
            listElement.innerHTML = '<p>Cargando...</p>';

            try {
                const response = await fetchWithRefresh(`${API_BASE_PRODUCTOS}/`, { cache: 'no-store' });
                if (!response.ok) throw new Error(await response.text());
                const productos = await response.json();

                const productosPorColeccion = {};
                productos.forEach(p => {
                    const col = p.coleccion || 'Sin colecci√≥n';
                    if (!productosPorColeccion[col]) {
                        productosPorColeccion[col] = [];
                    }
                    productosPorColeccion[col].push(p);
                });

                const items = productosPorColeccion[coleccion] || [];
                let itemsHtml = items.length > 0 ? '' : '<p>No hay productos en esta colecci√≥n</p>';
                items.forEach(p => {
                    const price = p.price !== undefined ? p.price.toFixed(2) : 'No especificado';
                    itemsHtml += `
                        <div class="producto-card">
                            <div>
                                <p><strong>Nombre:</strong> ${p.name || 'Sin nombre'}</p>
                                <p><strong>Descripci√≥n:</strong> ${p.description || 'Sin descripci√≥n'}</p>
                                <p><strong>Precio:</strong> $${price}</p>
                                <p><small>ID: ${p._id || 'Sin ID'}</small></p>
                            </div>
                            <div>
                                <button onclick="editProducto('${p._id}', '${p.name || ''}', '${p.description || ''}', '${p.price || ''}', '${p.coleccion || ''}')">Editar</button>
                                <button class="back" onclick="deleteProducto('${p._id}', '${p.coleccion || ''}')">Eliminar</button>
                            </div>
                        </div>
                    `;
                });

                const contentHtml = `
                    <div id="${tabId}" class="tab-content active">
                        ${itemsHtml}
                    </div>
                `;
                listElement.innerHTML = contentHtml;
                showTab('productos', tabId);
            } catch (error) {
                console.error('Error al cargar productos:', error);
                showAlert('productos-list', `Error: ${error.message}`, 'error');
            }
        }

        async function createProducto() {
            const producto = {
                name: document.getElementById('create-product-name').value.trim(),
                description: document.getElementById('create-product-description').value.trim(),
                price: parseFloat(document.getElementById('create-product-price').value) || 0
            };
            
            if (!producto.name) {
                showAlert('create-product-result', 'Nombre es requerido', 'error');
                return;
            }
            
            try {
                const response = await fetchWithRefresh(`${API_BASE_PRODUCTOS}/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(producto)
                });
                if (!response.ok) throw new Error(await response.text());
                const result = await response.json();
                showAlert('create-product-result', `${result.mensaje}`, 'success');
                document.getElementById('create-product-name').value = '';
                document.getElementById('create-product-description').value = '';
                document.getElementById('create-product-price').value = '';
                initializeProductosTabs();
            } catch (error) {
                console.error('Error al crear producto:', error);
                showAlert('create-product-result', `Error: ${error.message}`, 'error');
            }
        }

        function editProducto(id, name, description, price, coleccion) {
            document.getElementById('create-product-name').value = name;
            document.getElementById('create-product-description').value = description;
            document.getElementById('create-product-price').value = price === 'No especificado' ? '0' : price;
            const createButton = document.querySelector('#create-product-result').previousElementSibling;
            createButton.textContent = 'Actualizar Producto';
            createButton.onclick = () => updateProducto(id, coleccion);
        }

        async function updateProducto(id, coleccion) {
            const producto = {
                name: document.getElementById('create-product-name').value.trim(),
                description: document.getElementById('create-product-description').value.trim(),
                price: parseFloat(document.getElementById('create-product-price').value) || 0
            };
            
            try {
                const response = await fetchWithRefresh(`${API_BASE_PRODUCTOS}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(producto)
                });
                if (!response.ok) throw new Error(await response.text());
                const result = await response.json();
                showAlert('create-product-result', `${result.mensaje}`, 'success');
                document.getElementById('create-product-name').value = '';
                document.getElementById('create-product-description').value = '';
                document.getElementById('create-product-price').value = '';
                const createButton = document.querySelector('#create-product-result').previousElementSibling;
                createButton.textContent = 'Crear Producto';
                createButton.onclick = createProducto;
                initializeProductosTabs();
            } catch (error) {
                console.error('Error al actualizar producto:', error);
                showAlert('create-product-result', `Error: ${error.message}`, 'error');
            }
        }

        async function deleteProducto(id, coleccion) {
            if (!confirm('¬øEst√°s seguro de eliminar este producto?')) return;
            
            console.log(`Intentando eliminar producto con ID: ${id} de la colecci√≥n: ${coleccion}`);
            try {
                const response = await fetchWithRefresh(`${API_BASE_PRODUCTOS}/${id}?coleccion=${encodeURIComponent(coleccion || 'productos')}`, {
                    method: 'DELETE'
                });
                const responseData = await response.json();
                if (!response.ok) {
                    console.error('Respuesta de error del backend:', responseData);
                    throw new Error(responseData.detail || 'Error desconocido al eliminar el producto');
                }
                
                console.log('Respuesta del backend:', responseData);
                showAlert('productos-list', `${responseData.mensaje}`, 'success');
                initializeProductosTabs();
            } catch (error) {
                console.error('Error al eliminar producto:', error.message);
                showAlert('productos-list', `Error: ${error.message}`, 'error');
            }
        }

        // ===== FUNCIONES DE ENTIDADES =====
        async function getEntidades() {
            const tabsElement = document.getElementById('entidades-tabs');
            const listElement = document.getElementById('entidades-list');
            listElement.innerHTML = '<p>Selecciona una colecci√≥n para ver las entidades.</p>';
            tabsElement.innerHTML = '';

            try {
                const responseColecciones = await fetchWithRefresh(`${API_BASE_ENTIDADES}/`);
                if (!responseColecciones.ok) throw new Error(await responseColecciones.text());
                const colecciones = await responseColecciones.json();

                console.log('Colecciones recibidas:', colecciones);

                if (!Array.isArray(colecciones) || colecciones.length === 0) {
                    tabsElement.innerHTML = '';
                    listElement.innerHTML = '<p>No hay colecciones registradas</p>';
                    return;
                }

                let tabsHtml = '';
                for (const coleccion of colecciones) {
                    const responseEntidades = await fetchWithRefresh(`${API_BASE_ENTIDADES}/${coleccion}`);
                    const entidades = await responseEntidades.json();

                    console.log(`Entidades para ${coleccion}:`, entidades);

                    const safeColeccion = generateSafeId(coleccion);
                    const tabId = `entidades-tab-${safeColeccion}`;
                    tabsHtml += `<button class="tab" data-tab-id="${tabId}" onclick="loadEntidadesTab('${coleccion}', '${tabId}')">${coleccion} (${entidades.length})</button>`;
                }

                tabsElement.innerHTML = tabsHtml;
            } catch (error) {
                console.error('Error al obtener colecciones:', error);
                showAlert('entidades-list', `Error: ${error.message}`, 'error');
            }
        }

        async function loadEntidadesTab(coleccion, tabId) {
            const listElement = document.getElementById('entidades-list');
            listElement.innerHTML = '<p>Cargando...</p>';

            try {
                const response = await fetchWithRefresh(`${API_BASE_ENTIDADES}/${coleccion}`);
                if (!response.ok) throw new Error(await response.text());
                const entidades = await response.json();

                let itemsHtml = entidades.length > 0 ? '' : '<p>No hay entidades en esta colecci√≥n</p>';
                entidades.forEach(e => {
                    itemsHtml += `
                        <div>
                            <div>
                                <p><strong>Nombre:</strong> ${e.name || 'Sin nombre'}</p>
                                <p><strong>Descripci√≥n:</strong> ${e.description || 'Sin descripci√≥n'}</p>
                                <p><small>ID: ${e._id}</small></p>
                            </div>
                            <div>
                                <button onclick="editEntidad('${e._id}', '${e.name || ''}', '${e.description || ''}', '${coleccion}')">Editar</button>
                                <button class="back" onclick="deleteEntidad('${e._id}', '${coleccion}')">Eliminar</button>
                            </div>
                        </div>
                    `;
                });

                const contentHtml = `
                    <div id="${tabId}" class="tab-content active">
                        <div class="entidad-chip">
                            ${itemsHtml}
                            <button class="back" onclick="deleteColeccion('${coleccion}')">Eliminar Colecci√≥n</button>
                        </div>
                    </div>
                `;
                listElement.innerHTML = contentHtml;
                showTab('entidades', tabId);
            } catch (error) {
                console.error('Error al cargar entidades:', error);
                showAlert('entidades-list', `Error: ${error.message}`, 'error');
            }
        }

        async function createEntidad() {
            const coleccion = document.getElementById('entity-collection').value.trim().toLowerCase();
            const entidad = {
                name: document.getElementById('entity-name').value.trim(),
                description: document.getElementById('create-entity-description').value.trim()
            };
            
            if (!coleccion || !entidad.name) {
                showAlert('create-entity-result', 'Colecci√≥n y nombre son requeridos', 'error');
                return;
            }
            
            try {
                const response = await fetchWithRefresh(`${API_BASE_ENTIDADES}/${coleccion}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entidad)
                });
                if (!response.ok) throw new Error(await response.text());
                const result = await response.json();
                showAlert('create-entity-result', `${result.mensaje}`, 'success');
                document.getElementById('entity-collection').value = '';
                document.getElementById('entity-name').value = '';
                document.getElementById('create-entity-description').value = '';
                getEntidades();
            } catch (error) {
                console.error('Error al crear entidad:', error);
                showAlert('create-entity-result', `Error: ${error.message}`, 'error');
            }
        }

        function editEntidad(id, name, description, coleccion) {
            document.getElementById('entity-collection').value = coleccion;
            document.getElementById('entity-name').value = name;
            document.getElementById('create-entity-description').value = description;
            const createButton = document.querySelector('#create-entity-result').previousElementSibling;
            createButton.textContent = 'Actualizar Entidad';
            createButton.onclick = () => updateEntidad(id, coleccion);
        }

        async function updateEntidad(id, coleccion) {
            const entidad = {
                name: document.getElementById('entity-name').value.trim(),
                description: document.getElementById('create-entity-description').value.trim()
            };
            
            try {
                const response = await fetchWithRefresh(`${API_BASE_ENTIDADES}/${coleccion}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entidad)
                });
                if (!response.ok) throw new Error(await response.text());
                const result = await response.json();
                showAlert('create-entity-result', `${result.mensaje}`, 'success');
                document.getElementById('entity-collection').value = '';
                document.getElementById('entity-name').value = '';
                document.getElementById('create-entity-description').value = '';
                const createButton = document.querySelector('#create-entity-result').previousElementSibling;
                createButton.textContent = 'Crear Registro';
                createButton.onclick = createEntidad;
                getEntidades();
            } catch (error) {
                console.error('Error al actualizar entidad:', error);
                showAlert('create-entity-result', `Error: ${error.message}`, 'error');
            }
        }

        async function deleteEntidad(id, coleccion) {
            if (!confirm('¬øEst√°s seguro de eliminar esta entidad?')) return;

            console.log(`Intentando eliminar entidad con ID: ${id} de la colecci√≥n: ${coleccion}`);
            try {
                const response = await fetchWithRefresh(`${API_BASE_ENTIDADES}/${coleccion}/${id}`, {
                    method: 'DELETE'
                });
                const responseData = await response.json();
                if (!response.ok) {
                    console.error('Respuesta de error del backend:', responseData);
                    throw new Error(responseData.detail || 'Error desconocido al eliminar la entidad');
                }
                
                console.log('Respuesta del backend:', responseData);
                showAlert('entidades-list', `${responseData.mensaje}`, 'success');
                getEntidades();
            } catch (error) {
                console.error('Error al eliminar entidad:', error.message);
                showAlert('entidades-list', `Error: ${error.message}`, 'error');
            }
        }

        async function deleteColeccion(coleccion) {
            if (!confirm(`¬øEst√°s seguro de eliminar la colecci√≥n "${coleccion}"?`)) return;
            
            try {
                const response = await fetchWithRefresh(`${API_BASE_ENTIDADES}/${coleccion}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error(await response.text());
                const result = await response.json();
                showAlert('entidades-list', `${result.mensaje}`, 'success');
                getEntidades();
            } catch (error) {
                console.error('Error al eliminar colecci√≥n:', error);
                showAlert('entidades-list', `Error: ${error.message}`, 'error');
            }
        }

        // ===== FUNCIONES DE SCRAPING =====
        async function scrapeWebsite() {
            const url = document.getElementById('scrape-url').value.trim();

            if (!url) {
                showAlert('scrape-result', 'La URL es requerida', 'error');
                return;
            }

            try {
                const response = await fetchWithRefresh(`http://127.0.0.1:8000/scraping/?url=${encodeURIComponent(url)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error(await response.text());

                const blob = await response.blob();
                const contentDisposition = response.headers.get('Content-Disposition');
                const filenameMatch = contentDisposition && contentDisposition.match(/filename="(.+)"/);
                const filename = filenameMatch ? filenameMatch[1] : 'scraped_data.xlsx';

                const link = document.createElement('a');
                link.href = window.URL.createObjectURL(blob);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showAlert('scrape-result', 'Datos scrapeados y descargados exitosamente', 'success');
            } catch (error) {
                console.error('Error al scrapear:', error);
                showAlert('scrape-result', `Error: ${error.message}`, 'error');
            }
        }

        // ===== FUNCIONES DE NUBE DE PALABRAS =====
        async function generateWordcloud() {
            const text = document.getElementById('cloudwords-text').value.trim();
            if (!text) {
                showAlert('cloudwords-result', 'El texto es requerido', 'error');
                return;
            }
            
            document.getElementById('cloudwords-result').innerHTML = 'Generando nube de palabras...';
            
            try {
                const response = await fetchWithRefresh('http://127.0.0.1:8000/cloudwords/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        text: text,
                        language: "spanish",
                        title: "Nube de Palabras",
                        width: 800,
                        height: 400
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                const resultContainer = document.getElementById('cloudwords-result-container');
                resultContainer.innerHTML = `
                    <div class="producto-card">
                        <h3>Nube de Palabras Generada</h3>
                        <img src="${url}" alt="Nube de Palabras" style="max-width: 100%; height: auto; margin-top: 10px; border-radius: 8px;">
                        <div style="margin-top: 15px; display: flex; justify-content: space-between;">
                            <button onclick="downloadImage('${url}', 'nube_palabras.png')" style="width: 48%;">
                                <i class="fa-solid fa-download"></i> Descargar
                            </button>
                            <button onclick="generateNewWordcloud()" class="back" style="width: 48%;">
                                <i class="fa-solid fa-refresh"></i> Nueva Nube
                            </button>
                        </div>
                    </div>
                `;
                
                showAlert('cloudwords-result', 'Nube de palabras generada exitosamente', 'success');
            } catch (error) {
                console.error('Error al generar nube de palabras:', error);
                showAlert('cloudwords-result', `Error: ${error.message}`, 'error');
            }
        }

        function downloadImage(url, filename) {
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function generateNewWordcloud() {
            document.getElementById('cloudwords-result-container').innerHTML = '';
            document.getElementById('cloudwords-text').focus();
        }

        // ===== FUNCIONES DE LEMATIZACI√ìN =====
        async function lemmatizeText() {
            const text = document.getElementById('lemmatize-text').value.trim();
            const language = document.getElementById('lemmatize-language').value;
            const removeStopwords = document.getElementById('lemmatize-remove-stopwords').checked;
            
            if (!text) {
                showAlert('lemmatize-result', 'El texto es requerido', 'error');
                return;
            }
            
            try {
                const response = await fetchWithRefresh('http://127.0.0.1:8000/lemmatization/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text,
                        language,
                        remove_stopwords: removeStopwords
                    })
                });
                
                if (!response.ok) throw new Error(await response.text());
                
                const result = await response.json();
                
                const resultContainer = document.getElementById('lemmatize-result-container');
                resultContainer.innerHTML = `
                    <div class="producto-card">
                        <p><strong>Texto original (${result.tokens_count} tokens):</strong></p>
                        <p>${result.original_text}</p>
                        <hr style="border-color: #0ef; margin: 10px 0;">
                        <p><strong>Texto lematizado:</strong></p>
                        <p>${result.lemmatized_text}</p>
                    </div>
                `;
                
                showAlert('lemmatize-result', 'Texto lematizado exitosamente', 'success');
            } catch (error) {
                console.error('Error al lematizar texto:', error);
                showAlert('lemmatize-result', `Error: ${error.message}`, 'error');
            }
        }

        // ===== FUNCIONES RPA =====
        function toggleAdvancedOptions() {
            const advancedOptions = document.getElementById('advanced-options');
            advancedOptions.style.display = advancedOptions.style.display === 'none' ? 'block' : 'none';
        }

        function updateAppParams() {
            const selectedApp = document.querySelector('input[name="office-app"]:checked').value;
            
            document.getElementById('excel-params').style.display = 'none';
            
            if (selectedApp === 'excel') {
                document.getElementById('excel-params').style.display = 'block';
            }
        }

        function executeSimplifiedRPA() {
            const selectedApp = document.querySelector('input[name="office-app"]:checked').value;
            const fileName = document.getElementById('office-file-path').value.trim();
            const visibleProcess = document.getElementById('visible-process-checkbox').checked;
            const slowMode = document.getElementById('slow-mode-checkbox').checked;
            
            showAlert('office-automation-result', 'Ejecutando automatizaci√≥n...', 'success');
            
            const executeBtn = document.getElementById('execute-rpa-btn');
            executeBtn.disabled = true;
            executeBtn.textContent = "Ejecutando...";
            
            const progressDiv = document.getElementById('office-automation-progress');
            progressDiv.style.display = 'block';
            
            document.getElementById('step1').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> <span style="color: #0ef;">Iniciando aplicaci√≥n...</span>';
            
            let params = {
                app: selectedApp,
                action: "create",
                file_path: fileName,
                visible_process: visibleProcess,
                slow_mode: slowMode,
                wait_time: slowMode ? 10000 : 5000,
            };
            
            if (selectedApp === 'excel') {
                params.data = "T√≠tulo,Valor\nEjemplo 1,100\nEjemplo 2,200\nEjemplo 3,300";
                params.sheet_name = document.getElementById('excel-sheet-name')?.value || "Plantilla";
            } else if (selectedApp === 'word') {
                params.content = "Este es un documento creado autom√°ticamente mediante RPA.\n\nLa automatizaci√≥n rob√≥tica de procesos (RPA) permite crear documentos de manera autom√°tica sin intervenci√≥n manual.";
            } else if (selectedApp === 'powerpoint') {
                params.title = "Presentaci√≥n Autom√°tica";
                params.slides = "Automatizaci√≥n RPA|La automatizaci√≥n rob√≥tica de procesos permite crear presentaciones de manera eficiente sin intervenci√≥n manual.";
            }
            
            setTimeout(() => {
                document.getElementById('step1').innerHTML = '<i class="fa-solid fa-check"></i> <span style="color: #0ef;">Aplicaci√≥n iniciada</span>';
                document.getElementById('step2').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> <span style="color: #0ef;">Creando documento...</span>';
                
                setTimeout(() => {
                    document.getElementById('step2').innerHTML = '<i class="fa-solid fa-check"></i> <span style="color: #0ef;">Documento creado</span>';
                    document.getElementById('step3').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> <span style="color: #0ef;">Guardando archivo en el Escritorio...</span>';
                    
                    fetchWithRefresh('http://127.0.0.1:8000/rpa/office-automation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(params)
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(text);
                            });
                        }
                        return response.json();
                    })
                    .then(result => {
                        document.getElementById('step3').innerHTML = '<i class="fa-solid fa-check"></i> <span style="color: #0ef;">Archivo guardado en Escritorio</span>';
                        document.getElementById('step4').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> <span style="color: #0ef;">Finalizando proceso...</span>';
                        
                        setTimeout(() => {
                            document.getElementById('step4').innerHTML = '<i class="fa-solid fa-check"></i> <span style="color: #0ef;">Proceso finalizado</span>';
                            
                            let processMethod = result.visible_process ? 
                                '<span style="color: #4CAF50;">‚úì Visible (PyAutoGUI)</span>' : 
                                '<span style="color: #FFA500;">Modo sin interfaz</span>';
                            
                            showAlert('office-automation-result', `¬°Automatizaci√≥n completada exitosamente para ${selectedApp.toUpperCase()}!`, 'success');
                            
                            let savedFileName = result.details ? result.details.split('\\').pop() : 'documento_generado';
                            
                            const resultContainer = document.getElementById('office-automation-result');
                            const detailsDiv = document.createElement('div');
                            detailsDiv.classList.add('producto-card');
                            detailsDiv.style.marginTop = '15px';
                            detailsDiv.innerHTML = `
                                <p><strong>Estado:</strong> <span style="color: #4CAF50;">‚úì Completado</span></p>
                                <p><strong>Aplicaci√≥n:</strong> ${selectedApp.toUpperCase()}</p>
                                <p><strong>Archivo guardado como:</strong> <span style="color: #0ef; font-weight: 500;">${savedFileName}</span></p>
                                <p><strong>Ubicaci√≥n:</strong> <span style="color: #0ef; font-weight: 500;">Escritorio</span></p>
                                <p><strong>M√©todo de proceso:</strong> ${processMethod}</p>
                                <p><small>Se ha creado una plantilla b√°sica, guardado y cerrado la aplicaci√≥n autom√°ticamente.</small></p>
                            `;
                            
                            resultContainer.parentNode.insertBefore(detailsDiv, resultContainer.nextSibling);
                            
                            executeBtn.disabled = false;
                            executeBtn.textContent = "Ejecutar Automatizaci√≥n de Office";
                        }, 1500);
                    })
                    .catch(error => {
                        console.error('Error en automatizaci√≥n:', error);
                        
                        document.getElementById('step3').innerHTML = '<i class="fa-solid fa-times"></i> <span style="color: #ff5555;">Error al guardar archivo</span>';
                        document.getElementById('step4').innerHTML = '<i class="fa-solid fa-times"></i> <span style="color: #ff5555;">Proceso interrumpido</span>';
                        
                        showAlert('office-automation-result', `Error: ${error.message}`, 'error');
                        
                        if (error.message.includes('PyAutoGUI no est√° disponible') || error.message.includes('pyautogui')) {
                            const resultContainer = document.getElementById('office-automation-result');
                            const errorHelp = document.createElement('div');
                            errorHelp.classList.add('producto-card');
                            errorHelp.style.marginTop = '15px';
                            errorHelp.style.backgroundColor = 'rgba(255, 100, 100, 0.1)';
                            errorHelp.style.borderLeft = '3px solid #ff5555';
                            errorHelp.innerHTML = `
                                <p><strong>Error de PyAutoGUI:</strong> PyAutoGUI no est√° instalado o disponible en el servidor.</p>
                                <p>Requisitos para usar el modo visible:</p>
                                <ul style="padding-left: 20px; margin-top: 5px;">
                                    <li>PyAutoGUI debe estar instalado en el servidor: <code>pip install pyautogui</code></li>
                                    <li>El servidor debe tener una interfaz gr√°fica y permitir la automatizaci√≥n UI</li>
                                    <li>No se puede usar en servidores sin interfaz gr√°fica o en contenedores Docker sin configuraciones especiales</li>
                                </ul>
                                <p>Pruebe a desactivar "Mostrar proceso en pantalla" para usar el modo sin interfaz, que funcionar√° en cualquier entorno.</p>
                            `;
                            
                            resultContainer.parentNode.insertBefore(errorHelp, resultContainer.nextSibling);
                        }
                        
                        executeBtn.disabled = false;
                        executeBtn.textContent = "Ejecutar Automatizaci√≥n de Office";
                    });
                }, 2000);
            }, 1500);
        }

        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            // Manejar callback de OAuth si est√° presente en la URL
            handleOAuthCallback();
            
            // Inicializar la aplicaci√≥n
            checkUser();
            
            // Agregar listeners a los radio buttons de RPA
            const appRadios = document.querySelectorAll('input[name="office-app"]');
            appRadios.forEach(radio => {
                radio.addEventListener('change', updateAppParams);
            });
            
            // Inicializar par√°metros de RPA
            updateAppParams();
            
            // Manejo de errores no capturados en promesas
            window.addEventListener('unhandledrejection', function(event) {
                console.error('Unhandled promise rejection:', event.reason);
                showAlert('login-result', 'Error de conexi√≥n al servidor. Verifique que el backend est√© en ejecuci√≥n.', 'error');
            });
            
            // Forzar que la secci√≥n de registro sea visible inicialmente si no hay secciones mostradas
            setTimeout(function() {
                const activeSections = document.querySelectorAll('.content-section.active');
                if (activeSections.length === 0) {
                    showSection('register');
                }
            }, 500);
        });
    </script>
</body>
</html>